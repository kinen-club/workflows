name: Kinen Agent (Reusable)

on:
  workflow_call:
    inputs:
      kinen_url:
        description: 'Kinen Club URL (for fetching methodology)'
        required: false
        type: string
        default: 'https://kinen.club'
    secrets:
      OPENAI_API_KEY:
        description: 'OpenAI API key for Aider'
        required: false
      GEMINI_API_KEY:
        description: 'Google Gemini API key for Aider'
        required: false
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key for Aider'
        required: false

jobs:
  session:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Handle Session Start
        if: github.event.action == 'email_session_start'
        uses: actions/github-script@v7
        id: start-session
        with:
          script: |
            const { subject, body, from } = context.payload.client_payload;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: subject,
              body: `**From:** ${from}\n\n${body}`,
              labels: ['kinen-session']
            });

            console.log(`Created issue #${issue.data.number}`);
            core.setOutput('issue_number', issue.data.number);
            core.setOutput('user_email', from);
            return issue.data.number;

      - name: Handle Session Continue
        if: github.event.action == 'email_session_continue'
        uses: actions/github-script@v7
        id: continue-session
        with:
          script: |
            const { issue_number, body, from } = context.payload.client_payload;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issue_number),
              body: `**From:** ${from}\n\n${body}`
            });

            console.log(`Added comment to issue #${issue_number}`);
            core.setOutput('issue_number', issue_number);
            core.setOutput('user_email', from);
            return issue_number;

      - name: Get issue info
        id: issue
        run: |
          if [ "${{ github.event.action }}" == "email_session_start" ]; then
            echo "number=${{ steps.start-session.outputs.issue_number }}" >> $GITHUB_OUTPUT
            echo "email=${{ steps.start-session.outputs.user_email }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ steps.continue-session.outputs.issue_number }}" >> $GITHUB_OUTPUT
            echo "email=${{ steps.continue-session.outputs.user_email }}" >> $GITHUB_OUTPUT
          fi

      - name: Create/Checkout Session Branch
        run: |
          BRANCH="session/issue-${{ steps.issue.outputs.number }}"
          git fetch origin || true
          git checkout "$BRANCH" 2>/dev/null || git checkout -b "$BRANCH"
          git push -u origin "$BRANCH" || true

      - name: Determine LLM Provider
        id: llm
        run: |
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "provider=openai" >> $GITHUB_OUTPUT
            echo "model=gpt-4o" >> $GITHUB_OUTPUT
            echo "api_key=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "provider=gemini" >> $GITHUB_OUTPUT
            echo "model=gemini/gemini-3.0-pro" >> $GITHUB_OUTPUT
            echo "api_key=${{ secrets.GEMINI_API_KEY }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "provider=anthropic" >> $GITHUB_OUTPUT
            echo "model=claude-3-sonnet-20240229" >> $GITHUB_OUTPUT
            echo "api_key=${{ secrets.ANTHROPIC_API_KEY }}" >> $GITHUB_OUTPUT
          else
            echo "::error::No LLM API key configured. Add OPENAI_API_KEY, GEMINI_API_KEY, or ANTHROPIC_API_KEY to repo secrets."
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Aider
        run: |
          pip install aider-chat

      - name: Fetch Base Methodology
        id: methodology
        run: |
          # Fetch base methodology from kinen.club
          BASE_URL="${{ inputs.kinen_url }}/methodology.md"
          echo "Fetching base methodology from $BASE_URL"

          if curl -f -o /tmp/base-methodology.md "$BASE_URL" 2>/dev/null; then
            echo "base_fetched=true" >> $GITHUB_OUTPUT
            echo "Base methodology fetched successfully"
          else
            echo "base_fetched=false" >> $GITHUB_OUTPUT
            echo "::warning::Could not fetch base methodology, using custom only"
          fi

      - name: Build Combined Methodology
        run: |
          # Start with base methodology
          if [ -f /tmp/base-methodology.md ]; then
            cat /tmp/base-methodology.md > /tmp/full-methodology.md
          fi

          # Append custom instructions if exists
          if [ -f ".kinen/custom-instructions.md" ]; then
            echo "" >> /tmp/full-methodology.md
            echo "---" >> /tmp/full-methodology.md
            echo "" >> /tmp/full-methodology.md
            echo "# Custom Instructions" >> /tmp/full-methodology.md
            echo "" >> /tmp/full-methodology.md
            cat .kinen/custom-instructions.md >> /tmp/full-methodology.md
            echo "Custom instructions appended"
          elif [ -f ".kinen/methodology.md" ]; then
            # Fallback to old filename
            echo "" >> /tmp/full-methodology.md
            echo "---" >> /tmp/full-methodology.md
            echo "" >> /tmp/full-methodology.md
            echo "# Custom Instructions" >> /tmp/full-methodology.md
            echo "" >> /tmp/full-methodology.md
            cat .kinen/methodology.md >> /tmp/full-methodology.md
            echo "Custom instructions appended (from methodology.md)"
          fi

          echo "Full methodology built:"
          wc -l /tmp/full-methodology.md

      - name: Run Aider with Kinen Methodology
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          USER_MESSAGE="${{ github.event.client_payload.body }}"

          # Run Aider with:
          # - --read: methodology file (provides context/instructions)
          # - --message: just the user's request
          aider \
            --model ${{ steps.llm.outputs.model }} \
            --read /tmp/full-methodology.md \
            --message "Follow the methodology in the read files. User request: $USER_MESSAGE" \
            --yes \
            --no-auto-commits

      - name: Commit Changes
        run: |
          git config user.name "Kinen Bot"
          git config user.email "bot@kinen.club"
          git add .
          git diff --staged --quiet || git commit -m "Session update: Issue #${{ steps.issue.outputs.number }}"
          git push || true

      - name: Get changes summary
        id: summary
        run: |
          BRANCH="session/issue-${{ steps.issue.outputs.number }}"
          COMPARE_URL="https://github.com/${{ github.repository }}/compare/main...${BRANCH}"

          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null | head -10 | tr '\n' ', ' || echo "")

          echo "url=$COMPARE_URL" >> $GITHUB_OUTPUT
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: Post update comment
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = '${{ steps.summary.outputs.files }}'.split(',').filter(f => f).map(f => `- \`${f}\``).join('\n');

            const body = `### Session Updated âœ¨

            **Provider:** ${{ steps.llm.outputs.provider }}
            **Model:** ${{ steps.llm.outputs.model }}

            ${changedFiles ? `**Changed files:**\n${changedFiles}` : 'No file changes.'}

            [View all changes](${{ steps.summary.outputs.url }})`;

            await github.rest.issues.createComment({
              issue_number: ${{ steps.issue.outputs.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      # Email notification is handled automatically via GitHub webhook
      # When the bot posts a comment, GitHub sends issue_comment event to relay
      # Relay then sends email to user with the update
