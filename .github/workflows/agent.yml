# Kinen Agent Workflow (Reusable)
# Runs AI sessions triggered by email

name: Kinen Agent

on:
  workflow_call:
    inputs:
      methodology_url:
        description: 'URL to fetch base methodology'
        required: false
        type: string
        default: 'https://kinen.club/methodology.md'
      model:
        description: 'AI model to use (e.g., openrouter/anthropic/claude-sonnet-4-20250514)'
        required: false
        type: string
        default: ''
    secrets:
      GOOGLE_REFRESH_TOKEN:
        description: 'Google OAuth refresh token (FREE - 1000 requests/day, auto-saved by Kinen)'
        required: false
      OPENROUTER_API_KEY:
        description: 'OpenRouter API key (access to all models)'
        required: false
      OPENAI_API_KEY:
        description: 'OpenAI API key'
        required: false
      GEMINI_API_KEY:
        description: 'Google Gemini API key'
        required: false
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key'
        required: false

jobs:
  session:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Handle Session Start
        if: github.event.action == 'email_session_start'
        uses: actions/github-script@v7
        id: start-session
        with:
          script: |
            const { subject, body, from } = context.payload.client_payload;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: subject || 'New Kinen Session',
              body: '**From:** ' + from + '\n\n---\n\n' + body,
              labels: ['kinen-session']
            });

            console.log('Created issue #' + issue.data.number);
            core.setOutput('issue_number', issue.data.number);
            core.setOutput('user_email', from);
            return issue.data.number;

      - name: Handle Session Continue (Email)
        if: github.event.action == 'email_session_continue'
        uses: actions/github-script@v7
        id: continue-session
        with:
          script: |
            const { issue_number, body, from } = context.payload.client_payload;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issue_number),
              body: '**From:** ' + from + '\n\n---\n\n' + body
            });

            console.log('Added comment to issue #' + issue_number);
            core.setOutput('issue_number', issue_number);
            core.setOutput('user_email', from);
            core.setOutput('user_message', body);
            return issue_number;

      - name: Handle Issue Comment (GitHub UI)
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        id: issue-comment
        with:
          script: |
            const issue = context.payload.issue;
            const comment = context.payload.comment;

            console.log('Processing comment on issue #' + issue.number);
            console.log('Comment by: ' + comment.user.login);

            core.setOutput('issue_number', issue.number);
            core.setOutput('user_email', comment.user.login + '@github');
            core.setOutput('user_message', comment.body);
            return issue.number;

      - name: Get issue context
        id: issue
        run: |
          if [ "${{ github.event.action }}" == "email_session_start" ]; then
            echo "number=${{ steps.start-session.outputs.issue_number }}" >> $GITHUB_OUTPUT
            echo "email=${{ steps.start-session.outputs.user_email }}" >> $GITHUB_OUTPUT
            echo "message=${{ github.event.client_payload.body }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "number=${{ steps.issue-comment.outputs.issue_number }}" >> $GITHUB_OUTPUT
            echo "email=${{ steps.issue-comment.outputs.user_email }}" >> $GITHUB_OUTPUT
            echo "message<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.comment.body }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "number=${{ steps.continue-session.outputs.issue_number }}" >> $GITHUB_OUTPUT
            echo "email=${{ steps.continue-session.outputs.user_email }}" >> $GITHUB_OUTPUT
            echo "message=${{ github.event.client_payload.body }}" >> $GITHUB_OUTPUT
          fi

      - name: Create/Checkout Session Branch
        run: |
          BRANCH="session/issue-${{ steps.issue.outputs.number }}"
          git fetch origin || true

          if git show-ref --verify --quiet refs/remotes/origin/$BRANCH; then
            git checkout "$BRANCH"
            git pull origin "$BRANCH"
          else
            git checkout -b "$BRANCH"
          fi

          # Ensure sessions directory exists
          mkdir -p sessions
          echo "ðŸ“ Session directory ready"

      - name: Fetch Methodology
        id: methodology
        run: |
          # Fetch base methodology
          echo "Fetching methodology from ${{ inputs.methodology_url }}..."
          curl -sL "${{ inputs.methodology_url }}" > /tmp/base-methodology.md || echo "# Kinen AI Assistant" > /tmp/base-methodology.md

          # Append custom instructions if they exist
          if [ -f ".kinen/custom-instructions.md" ]; then
            echo "" >> /tmp/base-methodology.md
            echo "---" >> /tmp/base-methodology.md
            echo "" >> /tmp/base-methodology.md
            cat .kinen/custom-instructions.md >> /tmp/base-methodology.md
          fi

          echo "methodology_file=/tmp/base-methodology.md" >> $GITHUB_OUTPUT

      - name: Setup Google OAuth (if refresh token available)
        id: google-auth
        env:
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        run: |
          # Check if refresh token is provided
          if [ -z "$GOOGLE_REFRESH_TOKEN" ]; then
            echo "No Google refresh token provided, skipping OAuth setup"
            echo "auth_success=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ðŸ” Setting up Google OAuth credentials..."

          # Exchange refresh token via Kinen proxy (keeps client_secret secure)
          RESPONSE=$(curl -s -X POST https://kinen.club/api/token/google \
            -H "Content-Type: application/json" \
            -d "{\"refresh_token\": \"${GOOGLE_REFRESH_TOKEN}\"}")

          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')

          if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "âš ï¸ Failed to get access token from refresh token"
            echo "auth_success=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Create credentials file for gemini-cli/aider
          mkdir -p ~/.gemini
          cat > ~/.gemini/oauth-credentials.json << EOF
          {
            "access_token": "$ACCESS_TOKEN",
            "refresh_token": "$GOOGLE_REFRESH_TOKEN",
            "token_type": "Bearer",
            "scope": "https://www.googleapis.com/auth/cloud-platform openid email profile"
          }
          EOF

          chmod 600 ~/.gemini/oauth-credentials.json
          echo "âœ… Google OAuth credentials configured"
          echo "auth_success=true" >> $GITHUB_OUTPUT

      - name: Determine AI Provider
        id: provider
        env:
          INPUT_MODEL: ${{ inputs.model }}
          HAS_GOOGLE_AUTH: ${{ steps.google-auth.outputs.auth_success == 'true' }}
          HAS_OPENROUTER: ${{ secrets.OPENROUTER_API_KEY != '' }}
          HAS_ANTHROPIC: ${{ secrets.ANTHROPIC_API_KEY != '' }}
          HAS_GEMINI: ${{ secrets.GEMINI_API_KEY != '' }}
          HAS_OPENAI: ${{ secrets.OPENAI_API_KEY != '' }}
        run: |
          # If model is explicitly specified, use it
          if [ -n "$INPUT_MODEL" ]; then
            echo "model=$INPUT_MODEL" >> $GITHUB_OUTPUT
            echo "Using specified model: $INPUT_MODEL"
            exit 0
          fi

          # Otherwise, auto-detect based on available credentials
          # Priority: Google OAuth > OpenRouter > Anthropic > Gemini API Key > OpenAI
          if [ "$HAS_GOOGLE_AUTH" == "true" ]; then
            echo "model=gemini/gemini-2.5-pro" >> $GITHUB_OUTPUT
            echo "use_google_oauth=true" >> $GITHUB_OUTPUT
            echo "âœ¨ Using Google OAuth (FREE - 1000 requests/day)"
          elif [ "$HAS_OPENROUTER" == "true" ]; then
            echo "model=openrouter/anthropic/claude-sonnet-4.5" >> $GITHUB_OUTPUT
            echo "Using OpenRouter with Claude Sonnet 4.5"
          elif [ "$HAS_ANTHROPIC" == "true" ]; then
            echo "model=anthropic/claude-sonnet-4-20250514" >> $GITHUB_OUTPUT
            echo "Using Anthropic directly"
          elif [ "$HAS_GEMINI" == "true" ]; then
            echo "model=gemini/gemini-2.5-pro" >> $GITHUB_OUTPUT
            echo "Using Google Gemini API key"
          elif [ "$HAS_OPENAI" == "true" ]; then
            echo "model=gpt-4o" >> $GITHUB_OUTPUT
            echo "Using OpenAI"
          else
            echo "âŒ No AI credentials found! Options:"
            echo "   - Connect Google (FREE): Click 'Continue with Google' on Kinen"
            echo "   - OPENROUTER_API_KEY"
            echo "   - ANTHROPIC_API_KEY"
            echo "   - GEMINI_API_KEY"
            echo "   - OPENAI_API_KEY"
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Aider
        run: |
          # Install Aider (pip cache handled by setup-python)
          pip install aider-chat

          echo "ðŸ¤– Running Aider with model: ${{ steps.provider.outputs.model }}"
          echo "ðŸ“ User message: ${{ steps.issue.outputs.message }}"
          echo "ðŸ“„ Methodology file: ${{ steps.methodology.outputs.methodology_file }}"

          # Show methodology content (first 500 chars)
          echo "--- Methodology Preview ---"
          head -c 500 "${{ steps.methodology.outputs.methodology_file }}" || echo "Could not read methodology"
          echo ""
          echo "--- End Preview ---"

          # Get the user's message
          USER_MESSAGE="${{ steps.issue.outputs.message }}"

          # Run Aider and capture output
          echo "ðŸš€ Starting Aider..."
          aider \
            --model "${{ steps.provider.outputs.model }}" \
            --read "${{ steps.methodology.outputs.methodology_file }}" \
            --message "$USER_MESSAGE" \
            --yes-always \
            --no-auto-commits \
            2>&1 | tee /tmp/aider-output.log || {
              echo "âŒ Aider failed with exit code $?"
              echo "--- Aider Output ---"
              cat /tmp/aider-output.log || echo "No output log"
              exit 1
            }

          echo "âœ… Aider completed"
          echo "--- Aider Output ---"
          cat /tmp/aider-output.log || echo "No output log"

          # Show what files exist
          echo "--- Files in repo ---"
          find . -type f -name "*.md" -o -name "*.txt" | head -20 || echo "No markdown files found"

      - name: Commit Changes
        run: |
          git config user.name "Kinen Bot"
          git config user.email "bot@kinen.club"

          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "chore: session update for issue #${{ steps.issue.outputs.number }}"
            git push -u origin "session/issue-${{ steps.issue.outputs.number }}"
          else
            echo "No changes to commit"
          fi

      - name: Get changes summary
        id: summary
        run: |
          BRANCH="session/issue-${{ steps.issue.outputs.number }}"
          COMPARE_URL="https://github.com/${{ github.repository }}/compare/main...$BRANCH"
          echo "url=$COMPARE_URL" >> $GITHUB_OUTPUT

          # Get files changed
          FILES_CHANGED=$(git diff --name-only origin/main...HEAD 2>/dev/null | head -10 | tr '\n' ', ' || echo "none")
          echo "files=$FILES_CHANGED" >> $GITHUB_OUTPUT

          # Get Aider output if available
          if [ -f /tmp/aider-output.log ]; then
            AIDER_OUTPUT=$(cat /tmp/aider-output.log | tail -100)
            echo "aider_output<<EOF" >> $GITHUB_OUTPUT
            echo "$AIDER_OUTPUT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "aider_output=" >> $GITHUB_OUTPUT
          fi

      - name: Post AI Response
        uses: actions/github-script@v7
        with:
          script: |
            const filesChanged = '${{ steps.summary.outputs.files }}' || 'No files changed';
            const compareUrl = '${{ steps.summary.outputs.url }}';
            const aiderOutput = `${{ steps.summary.outputs.aider_output }}` || 'No output captured';

            const comment = [
              '## ðŸ¤– AI Session Update',
              '',
              'Session processing complete.',
              '',
              '### Changes',
              '- Files: ' + filesChanged,
              '- [View full diff](' + compareUrl + ')',
              '',
              '### Aider Output',
              '```',
              aiderOutput.substring(0, 2000), // Limit to 2000 chars
              aiderOutput.length > 2000 ? '\n... (truncated)' : '',
              '```',
              '',
              '---',
              '*Reply to this issue (or via email) to continue the conversation.*'
            ].join('\n');

            await github.rest.issues.createComment({
              issue_number: ${{ steps.issue.outputs.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

            console.log('Posted AI response to issue');

      # Note: Email notification is handled by GitHub App webhook
      # when this comment is posted (issue_comment event)
